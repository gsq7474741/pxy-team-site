# 国际化设计

本项目实现了完整的中英文国际化支持，涵盖前端 UI 文本和后端内容管理。

## 整体架构

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           国际化架构                                     │
│                                                                         │
│  ┌─────────────────┐         ┌─────────────────┐                        │
│  │   前端 UI 文本   │         │   CMS 内容数据   │                        │
│  │   (next-intl)   │         │   (Strapi i18n) │                        │
│  └────────┬────────┘         └────────┬────────┘                        │
│           │                           │                                 │
│           ▼                           ▼                                 │
│  ┌─────────────────┐         ┌─────────────────┐                        │
│  │ messages/*.json │         │   PostgreSQL    │                        │
│  │  zh-CN.json     │         │  (多语言内容)    │                        │
│  │  en.json        │         │                 │                        │
│  └────────┬────────┘         └────────┬────────┘                        │
│           │                           │                                 │
│           └─────────────┬─────────────┘                                 │
│                         ▼                                               │
│  ┌─────────────────────────────────────────────────────────────────────┐│
│  │                       语言检测与持久化                                ││
│  │                                                                      ││
│  │   Cookie: NEXT_LOCALE  ───────►  用户选择的语言                       ││
│  │   有效期: 30天                                                        ││
│  └─────────────────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────────────┘
```

## 语言检测优先级

```typescript
// 优先级从高到低
1. Cookie 中保存的用户选择 (NEXT_LOCALE)
2. 环境变量 (NEXT_PUBLIC_STRAPI_LOCALE)
3. 浏览器语言偏好 (navigator.language)
4. 默认语言 (zh-CN)
```

## 前端国际化实现

### 配置文件

#### `i18n/config.ts`

```typescript
export const locales = ['zh-CN', 'en'] as const;
export const defaultLocale = 'zh-CN';
export type Locale = (typeof locales)[number];
```

#### `i18n/request.ts`

```typescript
import { getRequestConfig } from 'next-intl/server';
import { cookies } from 'next/headers';
import { defaultLocale } from './config';

export default getRequestConfig(async () => {
  const cookieStore = await cookies();
  const localeCookie = cookieStore.get('NEXT_LOCALE');
  const locale = localeCookie?.value || defaultLocale;

  return {
    locale,
    messages: (await import(`../messages/${locale}.json`)).default
  };
});
```

### 翻译文件结构

#### `messages/zh-CN.json`

```json
{
  "nav": {
    "home": "首页",
    "research": "研究方向",
    "publications": "成果概览",
    "members": "团队成员",
    "news": "新闻动态",
    "join": "加入我们",
    "contact": "联系我们"
  },
  "home": {
    "research_title": "研究方向",
    "research_subtitle": "探索科技前沿，推动学术创新",
    "news_title": "最新动态",
    "news_subtitle": "了解团队最新研究进展和学术活动",
    "view_all_news": "查看全部新闻"
  },
  "common": {
    "loading": "加载中...",
    "view_details": "查看详情",
    "no_data": "暂无数据"
  }
}
```

#### `messages/en.json`

```json
{
  "nav": {
    "home": "Home",
    "research": "Research",
    "publications": "Publications",
    "members": "Team",
    "news": "News",
    "join": "Join Us",
    "contact": "Contact"
  },
  "home": {
    "research_title": "Research Areas",
    "research_subtitle": "Exploring cutting-edge technology and advancing academic innovation",
    "news_title": "Latest News",
    "news_subtitle": "Stay updated with our latest research progress and academic activities",
    "view_all_news": "View All News"
  },
  "common": {
    "loading": "Loading...",
    "view_details": "View Details",
    "no_data": "No data available"
  }
}
```

### 在组件中使用

#### 服务端组件

```typescript
// app/page.tsx
import { getTranslations } from 'next-intl/server';

export default async function Home() {
  const t = await getTranslations('home');
  
  return (
    <div>
      <h2>{t('research_title')}</h2>
      <p>{t('research_subtitle')}</p>
    </div>
  );
}
```

#### 客户端组件

```typescript
// components/Navbar.tsx
'use client';
import { useTranslations } from 'next-intl';

export default function Navbar() {
  const t = useTranslations('nav');
  
  return (
    <nav>
      <Link href="/">{t('home')}</Link>
      <Link href="/research">{t('research')}</Link>
    </nav>
  );
}
```

## 语言切换器

### 组件实现

```typescript
// components/LanguageSwitcher.tsx
'use client';

export function LanguageSwitcher() {
  const [currentLocale, setCurrentLocale] = useState('zh-CN');
  
  const switchLanguage = (locale: string) => {
    // 设置 Cookie，有效期 30 天
    document.cookie = `NEXT_LOCALE=${locale};path=/;max-age=${60*60*24*30}`;
    // 刷新页面应用新语言
    window.location.reload();
  };
  
  return (
    <button onClick={() => switchLanguage(currentLocale === 'zh-CN' ? 'en' : 'zh-CN')}>
      {currentLocale === 'zh-CN' ? 'EN' : '中文'}
    </button>
  );
}
```

## 后端 Strapi i18n

### 内容类型配置

```json
// schema.json
{
  "pluginOptions": {
    "i18n": {
      "localized": true
    }
  },
  "attributes": {
    "title": {
      "type": "string",
      "pluginOptions": {
        "i18n": {
          "localized": true  // 此字段需要翻译
        }
      }
    },
    "slug": {
      "type": "string",
      "pluginOptions": {
        "i18n": {
          "localized": false  // 此字段不需要翻译
        }
      }
    }
  }
}
```

### API 请求带 Locale

```typescript
// lib/strapi-client.ts
async getNewsList(page, pageSize, locale?: string) {
  const effectiveLocale = locale || getServerLocale();
  
  const response = await newsCollection.find({
    locale: effectiveLocale,  // zh-CN 或 en
    pagination: { page, pageSize }
  });
}
```

## Locale 工具函数

### 服务端获取 Locale

```typescript
// lib/server-locale.ts
import { cookies } from 'next/headers';

export async function getLocale(): Promise<string> {
  const cookieStore = await cookies();
  const localeCookie = cookieStore.get('NEXT_LOCALE');
  return localeCookie?.value || 'zh-CN';
}
```

### 客户端获取 Locale

```typescript
// lib/locale.ts
export function getClientLocale(): string {
  if (typeof window === 'undefined') return 'zh-CN';
  
  // 从 Cookie 读取
  const match = document.cookie.match(/NEXT_LOCALE=([^;]+)/);
  if (match) return match[1];
  
  // 浏览器语言
  return normalizeLocale(navigator.language);
}
```

### Locale 规范化

```typescript
// lib/locale.ts
export function normalizeLocale(locale: string): string {
  const normalized = locale.toLowerCase().replace('_', '-');
  
  // 中文变体 → zh-CN
  if (normalized.startsWith('zh')) return 'zh-CN';
  
  // 其他语言 → en
  return 'en';
}
```

## 翻译覆盖范围

| 模块 | 翻译键数量 | 说明 |
|------|-----------|------|
| nav | 7 | 导航栏 |
| home | 5 | 首页 |
| hero | 3 | Hero 区域 |
| research | 10 | 研究方向 |
| publications | 27 | 成果概览 |
| members | 10 | 团队成员 |
| footer | 7 | 页脚 |
| common | 8 | 通用文本 |

## 最佳实践

1. **翻译键命名** - 使用有意义的层级结构，如 `nav.home`
2. **默认值** - 始终提供默认语言的翻译
3. **动态内容** - CMS 内容通过 Strapi i18n 管理
4. **静态内容** - UI 文本通过 next-intl 管理
5. **Cookie 持久化** - 记住用户的语言选择
